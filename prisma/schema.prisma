// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== MULTI-TENANT MODELS ====================

model Tenant {
  id           String  @id @default(cuid())
  name         String
  slug         String? @unique // optional subdomain slug
  customDomain String? @unique @map("custom_domain")

  // Domain Verification
  domainVerificationToken String?   @map("domain_verification_token")
  domainVerified          Boolean   @default(false) @map("domain_verified")
  domainVerifiedAt        DateTime? @map("domain_verified_at")

  // Branding
  logo         String?
  favicon      String?
  primaryColor String? @default("#6A3BF6") @map("primary_color")

  // Business Info
  businessType BusinessType @default(SHOP) @map("business_type")
  gstNumber    String?      @map("gst_number")
  address      String?
  city         String?
  state        String?
  pincode      String?
  country      String       @default("India")
  phone        String?
  email        String?
  website      String?

  // Currency (legacy field for backwards compatibility)
  currency     String       @default("INR")
  // Default currency reference
  defaultCurrencyId String?   @map("default_currency_id")
  defaultCurrency   Currency? @relation("TenantCurrency", fields: [defaultCurrencyId], references: [id])
  // Allowed currencies for this tenant (JSON array of currency codes, e.g., ["INR", "USD"])
  // If empty or null, only the default currency is allowed
  allowedCurrencies Json?    @map("allowed_currencies") @db.JsonB

  // Payment Details (India)
  upiId         String? @map("upi_id")
  bankName      String? @map("bank_name")
  accountNumber String? @map("account_number")
  ifscCode      String? @map("ifsc_code")

  // Subscription
  plan          PlanType  @default(FREE)
  planExpiresAt DateTime? @map("plan_expires_at")

  // Settings
  settings           Json?
  isActive           Boolean      @default(false) @map("is_active")
  registrationStatus TenantStatus @default(PENDING) @map("registration_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users             User[]
  products          Product[]
  productLots       ProductLot[]
  categories        Category[]
  suppliers         Supplier[]
  customers         Customer[]
  invoices          Invoice[]
  repairTickets     RepairTicket[]
  stockMovements    StockMovement[]
  employees         Employee[]
  attendances       Attendance[]
  settlements       ConsignmentSettlement[]
  locations         Location[]
  stockTransfers    StockTransfer[]
  payslips          Payslip[]
  refundRequests    RefundRequest[]         @relation("TenantRefunds")
  inventoryRequests InventoryRequest[]      @relation("TenantInventoryRequests")
  securityLogs      SecurityLog[]
  customRoles       CustomRole[]
  holidays          Holiday[]
  whatsappMessages  WhatsAppMessage[]
  whatsappOptIns    WhatsAppOptIn[]
  blanketDiscounts  BlanketDiscount[]
  geoFences         GeoFence[]
  markets           Market[]

  // Orders & Shipments
  salesOrders       SalesOrder[]
  pickLists         PickList[]
  carrierAccounts   CarrierAccount[]
  shipments         Shipment[]
  codRemittances    CODRemittance[]

  // Purchase & Receiving
  purchaseOrders    PurchaseOrder[]
  goodsReceipts     GoodsReceipt[]

  // Returns & Waves
  returnRequests    ReturnRequest[]
  waves             Wave[]

  // Cycle Counting
  cycleCounts       CycleCount[]

  // Intelligence (Phase 5)
  demandSnapshots      DemandSnapshot[]
  reorderSuggestions   ReorderSuggestion[]
  inventoryKpiSnapshots InventoryKpiSnapshot[]

  // BOM / Kit Management (Phase 6)
  billsOfMaterial      BillOfMaterial[]
  assemblyOrders       AssemblyOrder[]

  // Supplier Payments (Phase 6)
  supplierPayments     SupplierPayment[]

  // Dynamic Pricing (Phase 7)
  pricingRules         PricingRule[]

  @@index([slug])
  @@index([customDomain])
  @@map("tenants")
}

enum BusinessType {
  SHOP
  COMPANY
  SERVICE_CENTER
  WAREHOUSE
  DISTRIBUTOR
}

enum PlanType {
  FREE
  STARTER
  BUSINESS
  ENTERPRISE
}

enum TenantStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== CURRENCY & MARKET MODELS ====================

// Supported currencies with exchange rates
model Currency {
  id        String   @id @default(cuid())
  code      String   @unique // ISO 4217 code (USD, EUR, INR, etc.)
  name      String   // US Dollar, Euro, Indian Rupee
  symbol    String   // $, €, ₹

  // Exchange rate relative to base currency (USD)
  exchangeRate  Decimal  @default(1) @map("exchange_rate") @db.Decimal(18, 8)

  // Formatting
  decimalPlaces Int     @default(2) @map("decimal_places")
  symbolPosition String @default("before") @map("symbol_position") // before, after
  thousandsSeparator String @default(",") @map("thousands_separator")
  decimalSeparator   String @default(".") @map("decimal_separator")

  isActive  Boolean  @default(true) @map("is_active")
  isBase    Boolean  @default(false) @map("is_base") // Base currency for exchange rates

  // Relations
  markets       Market[]
  productPrices ProductPrice[]
  tenants       Tenant[]       @relation("TenantCurrency")

  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@map("currencies")
}

// Market/Region for multi-currency pricing
model Market {
  id           String   @id @default(cuid())
  name         String   // US Market, EU Market, India
  code         String   @unique // US, EU, IN
  countryCodes String[] @map("country_codes") // ISO country codes

  // Default currency for this market
  currencyId   String   @map("currency_id")
  currency     Currency @relation(fields: [currencyId], references: [id])

  // Tax rate for this market
  taxRate      Decimal  @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxName      String?  @map("tax_name") // GST, VAT, Sales Tax

  isActive     Boolean  @default(true) @map("is_active")

  // Multi-tenant
  tenantId     String   @map("tenant_id")
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  productPrices ProductPrice[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("markets")
}

// Multi-currency product pricing
model ProductPrice {
  id        String  @id @default(cuid())

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Market/Region (optional - for region-specific pricing)
  marketId  String? @map("market_id")
  market    Market? @relation(fields: [marketId], references: [id])

  // Currency
  currencyId String   @map("currency_id")
  currency   Currency @relation(fields: [currencyId], references: [id])

  // Prices (stored as integers in smallest unit - cents/paise)
  costPrice     Int      @map("cost_price") // Cost in smallest currency unit
  sellingPrice  Int      @map("selling_price")
  compareAtPrice Int?    @map("compare_at_price") // Original/MRP price for showing discount

  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, currencyId, marketId])
  @@index([productId])
  @@index([currencyId])
  @@map("product_prices")
}

// ==================== USER & AUTH MODELS ====================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  password      String?
  phone         String?   @unique
  image         String?   @map("avatar")

  // Multi-tenant
  tenantId String? @map("tenant_id")
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Role & Permissions
  role         UserRole    @default(STAFF)
  permissions  Json?
  customRoleId String?     @map("custom_role_id")
  customRole   CustomRole? @relation("UserCustomRole", fields: [customRoleId], references: [id])

  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // NextAuth Relations
  accounts Account[]
  sessions Session[]

  // Business Relations
  createdInvoices Invoice[]        @relation("CreatedBy")
  assignedTickets RepairTicket[]   @relation("AssignedTo")
  stockMovements  StockMovement[]
  deliveries      Delivery[]       @relation("DeliveryAgent")
  backofficeStaff BackofficeStaff?

  // Orders & Shipments
  assignedPickLists PickList[]   @relation("PickerUser")

  // Cycle Counting
  assignedCycleCounts CycleCount[] @relation("CycleCountAssignee")
  verifiedCycleCounts CycleCount[] @relation("CycleCountVerifier")
  createdCycleCounts  CycleCount[] @relation("CycleCountCreator")

  // Biometric & Access Control
  profileImage    String?  @map("profile_image")
  fingerprintHash String?  @map("fingerprint_hash") // Encrypted template
  thumbprintHash  String?  @map("thumbprint_hash")
  rfidToken       String?  @unique @map("rfid_token")
  accessZones     String[] @default([]) @map("access_zones") // Array of zone IDs
  accessSchedule  Json?    @map("access_schedule") // Time-based access rules

  // Device tokens for push notifications
  deviceTokens    DeviceToken[]

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([customRoleId])
  @@map("users")
}

model CustomRole {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  @default("#6A3BF6")
  permissions String[]
  isDefault   Boolean  @default(false) @map("is_default")
  tenantId    String   @map("tenant_id")
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  users       User[]   @relation("UserCustomRole")

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("custom_roles")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Waitlist {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  businessName String?  @map("business_name")
  interests    String[] // ERP, Inventory, Shop Management, etc.
  status       String   @default("PENDING")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("waitlist")
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  MANAGER
  ACCOUNTANT
  TECHNICIAN
  SALES_STAFF
  VIEWER
  STAFF
}

// ==================== INVENTORY MODELS ====================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String
  description String?
  parentId    String?    @map("parent_id")
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  products Product[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([slug, tenantId])
  @@index([tenantId])
  @@map("categories")
}

model BlanketDiscount {
  id          String   @id @default(cuid())
  name        String
  description String?

  // Discount configuration
  discountType  DiscountType @default(PERCENTAGE) @map("discount_type")
  discountValue Decimal      @map("discount_value") @db.Decimal(12, 2)

  // Scope: what products this applies to
  scope    DiscountScope @default(ALL)
  scopeId  String?       @map("scope_id") // categoryId, supplierId, or brand name

  // Qualification rules
  minQuantity   Int?     @map("min_quantity")
  minOrderValue Decimal? @map("min_order_value") @db.Decimal(12, 2)
  maxUsageCount Int?     @map("max_usage_count") // Limit total usage
  usageCount    Int      @default(0) @map("usage_count")

  // Time bounds
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")

  // Priority (higher = takes precedence)
  priority Int @default(0)

  isActive Boolean @default(true) @map("is_active")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([isActive, startDate, endDate])
  @@map("blanket_discounts")
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum DiscountScope {
  ALL       // Applies to all products
  CATEGORY  // Applies to products in a specific category
  SUPPLIER  // Applies to products from a specific supplier
  BRAND     // Applies to products of a specific brand
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String?

  // Identifiers
  sku          String? // Stock Keeping Unit
  modelNumber  String? @map("model_number")
  serialNumber String? @unique @map("serial_number")
  barcode      String?
  hsnCode      String? @map("hsn_code") // For GST

  // Pricing
  costPrice  Decimal @map("cost_price") @db.Decimal(12, 2)
  modalPrice Decimal @map("modal_price") @db.Decimal(12, 2) // MRP
  salePrice  Decimal @map("sale_price") @db.Decimal(12, 2)
  discount   Decimal @default(0) @db.Decimal(5, 2) // Percentage

  // Stock
  quantity Int    @default(0)
  minStock Int    @default(0) @map("min_stock") // Reorder level
  maxStock Int?   @map("max_stock")
  unit     String @default("pcs") // pieces, kg, etc.

  // Media
  images String[] // Array of image URLs

  // Tax
  gstRate Decimal @default(18) @map("gst_rate") @db.Decimal(5, 2)

  // Categorization
  categoryId String?   @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id])
  brand      String?

  // Supplier
  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true) @map("is_active")

  // Intelligence (Phase 5)
  reorderPoint     Int?     @map("reorder_point")     // Calculated reorder trigger
  safetyStock      Int?     @map("safety_stock")      // Buffer stock quantity
  economicOrderQty Int?     @map("economic_order_qty") // EOQ calculation
  abcClass         String?  @map("abc_class")          // A, B, or C
  xyzClass         String?  @map("xyz_class")          // X, Y, or Z
  leadTimeDays     Int?     @map("lead_time_days")     // Avg days from order to receipt
  isPerishable     Boolean  @default(false) @map("is_perishable")

  // Order Smoothing (Phase 6)
  smoothingAlpha   Float? @map("smoothing_alpha")      // EMA alpha (0.01-0.99), null = default 0.2
  reviewPeriodDays Int?   @map("review_period_days")   // Periodic review cycle in days, null = default 7

  // Consignment
  isConsignment         Boolean  @default(false) @map("is_consignment")
  consignmentCommission Decimal? @map("consignment_commission") @db.Decimal(5, 2) // % for tenant

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  invoiceItems     InvoiceItem[]
  stockMovements   StockMovement[]
  repairTickets    RepairTicket[]
  settlements      ConsignmentSettlement[]
  stockAtLocations StockAtLocation[]
  transferItems    StockTransferItem[]

  // Lots/Batches
  lots ProductLot[]

  // Multi-currency pricing
  prices ProductPrice[]

  // Orders & Shipments
  salesOrderItems SalesOrderItem[]
  pickListItems   PickListItem[]

  // Purchase & Receiving
  purchaseOrderItems  PurchaseOrderItem[]
  goodsReceiptItems   GoodsReceiptItem[]
  returnRequestItems  ReturnRequestItem[]

  // Cycle Counting
  cycleCountItems     CycleCountItem[]

  // Intelligence (Phase 5)
  demandSnapshots     DemandSnapshot[]
  reorderSuggestions  ReorderSuggestion[]

  // Supply Chain (Phase 6)
  productSuppliers    ProductSupplier[] @relation("ProductSuppliers")

  // BOM / Kit Management (Phase 6)
  billsOfMaterial     BillOfMaterial[]  @relation("ProductBOMs")
  bomItems            BOMItem[]         @relation("ComponentBOMItems")

  @@unique([slug, tenantId])
  @@index([tenantId])
  @@index([serialNumber])
  @@index([barcode])
  @@map("products")
}

// Product Lot/Batch for tracking inventory batches
model ProductLot {
  id        String  @id @default(cuid())
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Lot identification
  lotNumber   String  @map("lot_number") // User-defined lot/batch number
  batchNumber String? @map("batch_number") // Optional secondary identifier

  // Quantity
  quantity         Int @default(0) // Current quantity in this lot
  initialQuantity  Int @map("initial_quantity") // Original quantity when lot was created

  // Pricing per lot (allows different costs per batch)
  costPrice Decimal @map("cost_price") @db.Decimal(12, 2)

  // Dates
  manufacturingDate DateTime? @map("manufacturing_date")
  expiryDate        DateTime? @map("expiry_date")
  purchaseDate      DateTime  @default(now()) @map("purchase_date")

  // Supplier (can be different per lot)
  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Status
  isActive Boolean @default(true) @map("is_active")
  notes    String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, lotNumber])
  @@index([tenantId])
  @@index([productId])
  @@index([expiryDate])
  @@index([lotNumber])
  @@map("product_lots")
}

model ConsignmentSettlement {
  id        String  @id @default(cuid())
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  invoiceId String  @map("invoice_id")
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  salePrice    Decimal @map("sale_price") @db.Decimal(12, 2)
  payoutAmount Decimal @map("payout_amount") @db.Decimal(12, 2) // Amount due to supplier

  status    SettlementStatus @default(UNSETTLED)
  settledAt DateTime?        @map("settled_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([supplierId])
  @@map("consignment_settlements")
}

enum SettlementStatus {
  UNSETTLED
  PAID
  CANCELLED
}

enum PaymentTermsDays {
  IMMEDIATE
  NET_7
  NET_15
  NET_30
  NET_45
  NET_60
  NET_90
  CUSTOM
}

model Supplier {
  id            String  @id @default(cuid())
  name          String
  contactPerson String? @map("contact_person")
  email         String?
  phone         String?
  whatsapp      String?

  // Address
  address String?
  city    String?
  state   String?
  pincode String?

  // Business
  gstNumber String? @map("gst_number")
  panNumber String? @map("pan_number")

  // Payment
  bankName      String? @map("bank_name")
  accountNumber String? @map("account_number")
  ifscCode      String? @map("ifsc_code")

  // Payment Terms (Phase 6)
  defaultPaymentTerms PaymentTermsDays? @map("default_payment_terms")
  customPaymentDays   Int?              @map("custom_payment_days")
  creditLimit         Decimal?          @map("credit_limit") @db.Decimal(12, 2)

  // Intelligence (Phase 5)
  avgLeadTimeDays  Int?     @map("avg_lead_time_days")  // Average delivery days
  reliabilityScore Decimal? @map("reliability_score") @db.Decimal(5, 2) // 0-100 score

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  products       Product[]
  productLots    ProductLot[]
  stockMovements StockMovement[]
  settlements    ConsignmentSettlement[]
  purchaseOrders PurchaseOrder[]
  goodsReceipts  GoodsReceipt[]
  reorderSuggestions ReorderSuggestion[]

  // Supply Chain (Phase 6)
  productSuppliers ProductSupplier[] @relation("SupplierProducts")
  supplierPayments SupplierPayment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("suppliers")
}

model StockMovement {
  id       String       @id @default(cuid())
  type     MovementType
  quantity Int

  // Reference
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  // Optional references
  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])
  invoiceId  String?   @map("invoice_id")

  // Details
  unitPrice  Decimal? @map("unit_price") @db.Decimal(12, 2)
  totalPrice Decimal? @map("total_price") @db.Decimal(12, 2)
  notes      String?

  // User who made the movement
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([productId])
  @@map("stock_movements")
}

enum MovementType {
  PURCHASE // Stock In - Purchase
  SALE // Stock Out - Sale
  RETURN_IN // Stock In - Customer return
  RETURN_OUT // Stock Out - Return to supplier
  ADJUSTMENT // Manual adjustment
  TRANSFER // Transfer between locations
  DAMAGE // Stock Out - Damaged
  REPAIR_IN // Stock In - From repair
  REPAIR_OUT // Stock Out - For repair
  CYCLE_COUNT // Adjustment from cycle count
  ASSEMBLY_CONSUME // Components consumed during assembly
  ASSEMBLY_PRODUCE // Finished goods produced from assembly
}

// ==================== CUSTOMER & INVOICE MODELS ====================

model Customer {
  id       String  @id @default(cuid())
  name     String
  email    String?
  phone    String?
  whatsapp String?

  // Address
  address String?
  city    String?
  state   String?
  pincode String?

  // Business (for B2B)
  companyName String? @map("company_name")
  gstNumber   String? @map("gst_number")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  invoices       Invoice[]
  repairTickets  RepairTicket[]
  salesOrders    SalesOrder[]
  returnRequests ReturnRequest[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([phone])
  @@map("customers")
}

model SecurityLog {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId    String? @map("user_id")
  action    String // e.g., "SENSITIVE_DATA_UPDATE", "LOGIN_SUCCESS", "KEY_ROTATION"
  resource  String? // e.g., "TenantSettings", "Invoice:INV-001"
  details   Json?
  ipAddress String? @map("ip_address")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([action])
  @@map("security_logs")
}

model Invoice {
  id            String @id @default(cuid())
  invoiceNumber String @unique @map("invoice_number")

  // Customer
  customerId String?   @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])

  // Amounts
  subtotal       Decimal @db.Decimal(12, 2)
  discount       Decimal @default(0) @db.Decimal(12, 2)
  taxAmount      Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  total          Decimal @db.Decimal(12, 2)
  currency       String  @default("INR")
  isTaxInclusive Boolean @default(false) @map("is_tax_inclusive")

  // Payment
  paidAmount    Decimal       @default(0) @map("paid_amount") @db.Decimal(12, 2)
  paymentMode   PaymentMode?  @map("payment_mode")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Status
  status InvoiceStatus @default(DRAFT)

  // Dates
  invoiceDate DateTime  @default(now()) @map("invoice_date")
  dueDate     DateTime? @map("due_date")

  // Notes
  notes              String?
  termsAndConditions String? @map("terms_and_conditions")

  // GST Compliance (e-Invoicing)
  irn           String? @unique // Invoice Reference Number
  signedQrCode  String? @map("signed_qr_code") // For government QR
  signedInvoice String? @map("signed_invoice") // Official signed XML/JSON
  gstStatus     String? @default("NOT_GENERATED") @map("gst_status") // NOT_GENERATED, GENERATED, CANCELLED, FAILED

  // User who created
  createdById String @map("created_by_id")
  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id])

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  items       InvoiceItem[]
  settlements ConsignmentSettlement[]
  deliveries  Delivery[]
  salesOrders SalesOrder[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([customerId])
  @@map("invoices")
}

// Delivery model for tracking shipments
model Delivery {
  id String @id @default(cuid())

  invoiceId String  @map("invoice_id")
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Delivery agent
  deliveryAgentId String? @map("delivery_agent_id")
  deliveryAgent   User?   @relation("DeliveryAgent", fields: [deliveryAgentId], references: [id])

  // Address
  address String?
  city    String?
  pincode String?

  // Status tracking
  status        DeliveryStatus @default(PENDING)
  scheduledDate DateTime?      @map("scheduled_date")
  deliveredAt   DateTime?      @map("delivered_at")

  // Proof of delivery
  proofPhoto String? @map("proof_photo")
  signature  String?
  notes      String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([invoiceId])
  @@index([deliveryAgentId])
  @@map("deliveries")
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELLED
}

model InvoiceItem {
  id String @id @default(cuid())

  invoiceId String  @map("invoice_id")
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id])

  description String
  hsnCode     String? @map("hsn_code")
  quantity    Int
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  discount    Decimal @default(0) @db.Decimal(12, 2)
  taxRate     Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount   Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  total       Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("invoice_items")
}

enum PaymentMode {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  CHEQUE
  CREDIT
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  REFUNDED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

// ==================== REPAIR & SERVICE MODELS ====================

model RepairTicket {
  id           String @id @default(cuid())
  ticketNumber String @unique @map("ticket_number")

  // Product Info
  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id])

  productName  String  @map("product_name")
  modelNumber  String? @map("model_number")
  serialNumber String? @map("serial_number")

  // Customer
  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])

  // Issue
  issueDescription String   @map("issue_description")
  images           String[] // Before repair photos

  // Assignment
  assignedToId String? @map("assigned_to_id")
  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id])

  // Status & Priority
  status   RepairStatus   @default(RECEIVED)
  priority RepairPriority @default(MEDIUM)

  // Diagnosis & Repair
  diagnosis   String?
  repairNotes String? @map("repair_notes")
  partsUsed   Json?   @map("parts_used") // Array of parts with cost

  // Costs
  laborCost Decimal @default(0) @map("labor_cost") @db.Decimal(12, 2)
  partsCost Decimal @default(0) @map("parts_cost") @db.Decimal(12, 2)
  totalCost Decimal @default(0) @map("total_cost") @db.Decimal(12, 2)

  // Warranty
  warrantyPeriod  Int?      @map("warranty_period") // in days
  warrantyExpires DateTime? @map("warranty_expires")

  // Dates
  receivedAt  DateTime  @default(now()) @map("received_at")
  diagnosedAt DateTime? @map("diagnosed_at")
  repairedAt  DateTime? @map("repaired_at")
  deliveredAt DateTime? @map("delivered_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([ticketNumber])
  @@index([customerId])
  @@map("repair_tickets")
}

enum RepairStatus {
  RECEIVED
  DIAGNOSED
  WAITING_APPROVAL
  WAITING_PARTS
  IN_REPAIR
  QUALITY_CHECK
  READY
  DELIVERED
  CANCELLED
}

enum RepairPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ==================== HR & ATTENDANCE MODELS ====================

model Employee {
  id         String  @id @default(cuid())
  employeeId String  @map("employee_id") // Company employee ID
  name       String
  email      String?
  phone      String?

  // Personal
  dateOfBirth DateTime? @map("date_of_birth")
  gender      String?
  address     String?

  // Employment
  designation String?
  department  String?
  joinDate    DateTime  @map("join_date")
  exitDate    DateTime? @map("exit_date")

  // Salary
  baseSalary        Decimal @map("base_salary") @db.Decimal(12, 2)
  standardWorkHours Float   @default(8) @map("standard_work_hours") // Hours per day
  overtimeRate      Float   @default(1.5) @map("overtime_rate") // Multiplier (1.5x, 2x, etc.)

  // Documents
  panNumber    String? @map("pan_number")
  aadharNumber String? @map("aadhar_number")
  bankAccount  String? @map("bank_account")
  ifscCode     String? @map("ifsc_code")

  isActive Boolean @default(true) @map("is_active")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  attendances   Attendance[]
  leaves        Leave[]
  payslips      Payslip[]
  leaveBalances LeaveBalance[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, tenantId])
  @@index([tenantId])
  @@map("employees")
}

model Attendance {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  employeeId String   @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  checkIn  DateTime? @map("check_in")
  checkOut DateTime? @map("check_out")

  // Hours tracking
  hoursWorked    Float @default(0) @map("hours_worked")
  overtimeHours  Float @default(0) @map("overtime_hours")

  status AttendanceStatus @default(PRESENT)

  // Location (optional GPS)
  checkInLat  Float? @map("check_in_lat")
  checkInLng  Float? @map("check_in_lng")
  checkOutLat Float? @map("check_out_lat")
  checkOutLng Float? @map("check_out_lng")

  notes String?

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, date])
  @@index([tenantId])
  @@index([date])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LATE
  ON_LEAVE
  HOLIDAY
}

model GeoFence {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Location center
  latitude  Float
  longitude Float

  // Radius in meters
  radius Int @default(100)

  // Settings
  isActive  Boolean @default(true) @map("is_active")
  isDefault Boolean @default(false) @map("is_default") // Default fence for all employees

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("geo_fences")
}

model Leave {
  id String @id @default(cuid())

  employeeId String   @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  leaveType LeaveType @map("leave_type")
  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime  @map("end_date") @db.Date

  reason String?
  status LeaveStatus @default(PENDING)

  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("leaves")
}

enum LeaveType {
  CASUAL
  SICK
  EARNED
  UNPAID
  MATERNITY
  PATERNITY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollStatus {
  DRAFT
  PROCESSED
  PAID
  CANCELLED
}

// ==================== HOLIDAY MODEL ====================

model Holiday {
  id         String   @id @default(cuid())
  name       String
  date       DateTime @db.Date
  isOptional Boolean  @default(false) @map("is_optional")
  tenantId   String?  @map("tenant_id") // Null = global holidays (e.g., national)
  tenant     Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([date, tenantId])
  @@index([tenantId])
  @@map("holidays")
}

model LeaveBalance {
  id         String   @id @default(cuid())
  employeeId String   @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  year       Int

  casualTotal  Int @default(12) @map("casual_total")
  casualUsed   Int @default(0) @map("casual_used")
  sickTotal    Int @default(12) @map("sick_total")
  sickUsed     Int @default(0) @map("sick_used")
  earnedTotal  Int @default(15) @map("earned_total")
  earnedUsed   Int @default(0) @map("earned_used")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, year])
  @@map("leave_balances")
}

model Location {
  id      String       @id @default(cuid())
  name    String
  code    String? // e.g. WH-01
  address String?
  city    String?
  state   String?
  pincode String?
  type    LocationType @default(STORE)

  // Location Hierarchy (for large warehouses)
  parentId String?    @map("parent_id")
  parent   Location?  @relation("LocationHierarchy", fields: [parentId], references: [id])
  children Location[] @relation("LocationHierarchy")
  subType  String?    @default("ZONE") @map("sub_type") // ZONE, SECTION, RACK, BIN

  // Capacity Management
  capacity    Int? // Max units capacity
  currentLoad Int  @default(0) @map("current_load")
  maxWeightKg Float? @map("max_weight_kg")  // Max weight in kg
  maxVolumeCbm Float? @map("max_volume_cbm") // Max volume in cubic metres

  // Inventory-level discount
  discount Decimal @default(0) @db.Decimal(5, 2) // Percentage discount for all items
  isActive Boolean @default(true) @map("is_active")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  stock         StockAtLocation[]
  transfersFrom StockTransfer[]   @relation("SourceLocation")
  transfersTo   StockTransfer[]   @relation("DestinationLocation")

  // Orders & Shipments
  salesOrders   SalesOrder[]      @relation("OrderSourceLocation")
  pickLists     PickList[]
  pickListItems PickListItem[]    @relation("PickSourceLocation")

  // Purchase & Receiving
  purchaseOrders PurchaseOrder[] @relation("PODeliveryLocation")
  goodsReceipts  GoodsReceipt[]  @relation("GRNReceivingLocation")

  // Cycle Counting
  cycleCounts CycleCount[] @relation("CycleCountLocation")

  // BOM / Kit Management (Phase 6)
  assemblyOrders AssemblyOrder[] @relation("AssemblyLocation")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([name, tenantId])
  @@unique([code, tenantId])
  @@index([tenantId])
  @@index([parentId])
  @@map("locations")
}

enum LocationType {
  STORE
  WAREHOUSE
  SERVICE_CENTER
}

model StockAtLocation {
  id        String  @id @default(cuid())
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  locationId String   @map("location_id")
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  quantity Int @default(0)

  @@unique([productId, locationId])
  @@map("stock_at_locations")
}

model StockTransfer {
  id             String @id @default(cuid())
  transferNumber String @unique @map("transfer_number")

  sourceLocationId String   @map("source_location_id")
  sourceLocation   Location @relation("SourceLocation", fields: [sourceLocationId], references: [id])

  destLocationId String   @map("dest_location_id")
  destLocation   Location @relation("DestinationLocation", fields: [destLocationId], references: [id])

  status TransferStatus @default(PENDING)
  notes  String?

  // GST Compliance (e-Way Bill)
  ewayBillNumber  String?   @unique @map("eway_bill_number")
  ewayBillDate    DateTime? @map("eway_bill_date")
  transporterId   String?   @map("transporter_id")
  transporterName String?   @map("transporter_name")
  vehicleNumber   String?   @map("vehicle_number")
  distance        Int? // In KM

  items StockTransferItem[]

  // Auditing
  createdById  String  @map("created_by_id")
  approvedById String? @map("approved_by_id")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("stock_transfers")
}

model StockTransferItem {
  id         String        @id @default(cuid())
  transferId String        @map("transfer_id")
  transfer   StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  quantity Int

  @@map("stock_transfer_items")
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model Payslip {
  id    String @id @default(cuid())
  month Int
  year  Int

  employeeId String   @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  baseSalary  Decimal @map("base_salary") @db.Decimal(12, 2)
  workingDays Int     @map("working_days")
  presentDays Int     @map("present_days")
  leaveDays   Int     @map("leave_days")

  overtimeHours Float   @default(0) @map("overtime_hours")
  overtimePay   Decimal @default(0) @map("overtime_pay") @db.Decimal(12, 2)

  deductions Decimal @default(0) @db.Decimal(12, 2)
  bonus      Decimal @default(0) @db.Decimal(12, 2)

  netSalary Decimal @map("net_salary") @db.Decimal(12, 2)

  status PayrollStatus @default(DRAFT)
  paidAt DateTime?     @map("paid_at")

  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([employeeId, month, year])
  @@index([tenantId])
  @@map("payslips")
}

// ==================== BACKOFFICE & ADMIN MODELS ====================

model BackofficeStaff {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Role & Module Access
  permissions Json // Map of module -> access level (e.g., { "TENANTS": "READ", "REFUNDS": "WRITE" })

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("backoffice_staff")
}

model Promotion {
  id          String        @id @default(cuid())
  title       String
  content     String
  type        PromotionType @default(EMAIL)
  targetPlans PlanType[]    @map("target_plans")

  status      PromotionStatus @default(DRAFT)
  scheduledAt DateTime?       @map("scheduled_at")
  sentAt      DateTime?       @map("sent_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("promotions")
}

enum PromotionType {
  EMAIL
  DASHBOARD_BANNER
  SMS
}

enum PromotionStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELLED
}

model RefundRequest {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation("TenantRefunds", fields: [tenantId], references: [id])

  invoiceId String?      @map("invoice_id")
  amount    Decimal      @db.Decimal(12, 2)
  reason    String
  status    RefundStatus @default(OPEN)

  // Communication
  messages Json? // Array of { sender, message, sentAt }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("refund_requests")
}

enum RefundStatus {
  OPEN
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMPLETED
}

model InventoryRequest {
  id       String @id @default(cuid())
  tenantId String @map("tenant_id")
  tenant   Tenant @relation("TenantInventoryRequests", fields: [tenantId], references: [id])

  type    String @default("PRODUCT") // PRODUCT or CATEGORY
  details Json // Details of what to add

  status    RequestStatus @default(PENDING)
  adminNote String?       @map("admin_note")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("inventory_requests")
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== WHATSAPP MODELS ====================

model WhatsAppMessage {
  id            String           @id @default(cuid())
  tenantId      String           @map("tenant_id")
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  direction     MessageDirection
  phone         String
  messageId     String?          @unique @map("message_id") // WhatsApp message ID
  templateName  String?          @map("template_name")
  messageType   String           @map("message_type") // utility, marketing, authentication
  content       String?          @db.Text
  status        MessageStatus    @default(PENDING)
  sentAt        DateTime?        @map("sent_at")
  deliveredAt   DateTime?        @map("delivered_at")
  readAt        DateTime?        @map("read_at")
  failedAt      DateTime?        @map("failed_at")
  errorMessage  String?          @map("error_message")
  referenceType String?          @map("reference_type") // invoice, order, repair, etc.
  referenceId   String?          @map("reference_id")
  retryCount    Int              @default(0) @map("retry_count")
  nextRetryAt   DateTime?        @map("next_retry_at")
  costPaise     Int              @default(0) @map("cost_paise") // Cost in paise (1/100 rupee)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([phone])
  @@index([status])
  @@index([referenceType, referenceId])
  @@map("whatsapp_messages")
}

model WhatsAppOptIn {
  id       String   @id @default(cuid())
  tenantId String   @map("tenant_id")
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phone    String
  optedIn  Boolean  @default(true) @map("opted_in")
  optInAt  DateTime @map("opt_in_at")
  optOutAt DateTime? @map("opt_out_at")
  source   String?  // web, invoice, manual, etc.

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([phone, tenantId])
  @@index([tenantId])
  @@map("whatsapp_opt_ins")
}

enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  RETRY_SCHEDULED
}

// ==================== PRODUCT CATALOG (BARCODE DATABASE) ====================

model ProductCatalog {
  id           String   @id @default(cuid())
  barcode      String   @unique
  name         String
  description  String?  @db.Text
  brand        String?
  manufacturer String?
  category     String?
  subcategory  String?
  hsnCode      String?  @map("hsn_code")
  gstRate      Float    @default(18) @map("gst_rate")
  mrp          Decimal? @db.Decimal(12, 2)
  imageUrl     String?  @map("image_url")
  thumbnailUrl String?  @map("thumbnail_url")
  specifications Json?  // Product specifications as JSON
  source       CatalogSource @default(MANUAL) // Where this data came from
  sourceId     String?  @map("source_id") // ID from external source
  isVerified   Boolean  @default(false) @map("is_verified")
  usageCount   Int      @default(0) @map("usage_count") // How many times this was used

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([barcode])
  @@index([name])
  @@index([brand])
  @@index([category])
  @@map("product_catalog")
}

enum CatalogSource {
  MANUAL
  OPEN_FOOD_FACTS
  UPC_DATABASE
  GS1_INDIA
  USER_CONTRIBUTED
  CSV_IMPORT
}

// ==================== DEVICE TOKENS (PUSH NOTIFICATIONS) ====================

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  platform  String   // 'web', 'ios', 'android'
  deviceInfo Json?   @map("device_info")
  isActive  Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("device_tokens")
}

// ==================== CONTACT FORM SUBMISSIONS ====================

model ContactSubmission {
  id       String @id @default(cuid())
  name     String
  email    String
  phone    String?
  company  String?
  message  String @db.Text
  plan     String? // Interest in specific plan
  source   String? // Where they heard about us

  // Status tracking
  status      ContactStatus @default(NEW)
  assignedTo  String?       @map("assigned_to")
  notes       String?       @db.Text

  // Response tracking
  respondedAt DateTime? @map("responded_at")
  responseBy  String?   @map("response_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("contact_submissions")
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESPONDED
  CONVERTED
  CLOSED
}

// ==================== SALES ORDERS & FULFILLMENT ====================

model SalesOrder {
  id          String @id @default(cuid())
  orderNumber String @unique @map("order_number")

  // Customer
  customerId String?   @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])

  // Shipping Address
  shippingName    String  @map("shipping_name")
  shippingPhone   String  @map("shipping_phone")
  shippingEmail   String? @map("shipping_email")
  shippingAddress String  @map("shipping_address")
  shippingCity    String  @map("shipping_city")
  shippingState   String  @map("shipping_state")
  shippingPincode String  @map("shipping_pincode")
  shippingCountry String  @default("India") @map("shipping_country")

  // Billing Address (optional, defaults to shipping)
  billingName    String? @map("billing_name")
  billingPhone   String? @map("billing_phone")
  billingAddress String? @map("billing_address")
  billingCity    String? @map("billing_city")
  billingState   String? @map("billing_state")
  billingPincode String? @map("billing_pincode")

  // Amounts
  subtotal  Decimal @db.Decimal(12, 2)
  discount  Decimal @default(0) @db.Decimal(12, 2)
  taxAmount Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  shipping  Decimal @default(0) @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)
  currency  String  @default("INR")

  // Payment
  paymentMode   PaymentMode?  @map("payment_mode")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  isCOD         Boolean       @default(false) @map("is_cod")
  codAmount     Decimal?      @map("cod_amount") @db.Decimal(12, 2)

  // Status
  status            OrderStatus      @default(DRAFT)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED) @map("fulfillment_status")

  // Source Location (warehouse to fulfill from)
  sourceLocationId String?   @map("source_location_id")
  sourceLocation   Location? @relation("OrderSourceLocation", fields: [sourceLocationId], references: [id])

  // Linked Invoice
  invoiceId String?  @map("invoice_id")
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  // Package Dimensions (for shipping rate calculation)
  weightGrams Int? @map("weight_grams")
  lengthCm    Int? @map("length_cm")
  breadthCm   Int? @map("breadth_cm")
  heightCm    Int? @map("height_cm")

  // Channel/Source
  channel String? // MANUAL, WEBSITE, MARKETPLACE

  // Notes
  notes          String?
  internalNotes  String? @map("internal_notes")

  // Audit
  createdById String @map("created_by_id")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  items          SalesOrderItem[]
  pickLists      PickList[]
  shipments      Shipment[]
  returnRequests ReturnRequest[]
  waveOrders     WaveOrder[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([fulfillmentStatus])
  @@index([createdAt])
  @@map("sales_orders")
}

model SalesOrderItem {
  id String @id @default(cuid())

  orderId String     @map("order_id")
  order   SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id])

  // Product snapshot (in case product changes later)
  productName String  @map("product_name")
  sku         String?
  hsnCode     String? @map("hsn_code")

  // Quantity & Pricing
  quantity  Int
  unitPrice Decimal @map("unit_price") @db.Decimal(12, 2)
  discount  Decimal @default(0) @db.Decimal(12, 2)
  taxRate   Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  // Fulfillment tracking
  pickedQty  Int @default(0) @map("picked_qty")
  packedQty  Int @default(0) @map("packed_qty")
  shippedQty Int @default(0) @map("shipped_qty")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@index([productId])
  @@map("sales_order_items")
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  ON_HOLD
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
}

// ==================== PICK & PACK ====================

model PickList {
  id         String @id @default(cuid())
  pickNumber String @unique @map("pick_number")

  // Order link
  orderId String     @map("order_id")
  order   SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Source location
  locationId String   @map("location_id")
  location   Location @relation(fields: [locationId], references: [id])

  // Assigned picker
  assignedToId String? @map("assigned_to_id")
  assignedTo   User?   @relation("PickerUser", fields: [assignedToId], references: [id])

  // Status
  status PickStatus @default(PENDING)

  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  notes String?

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  items PickListItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([orderId])
  @@index([status])
  @@map("pick_lists")
}

model PickListItem {
  id String @id @default(cuid())

  pickListId String   @map("pick_list_id")
  pickList   PickList @relation(fields: [pickListId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  // Source bin/location for picking
  sourceLocationId String?   @map("source_location_id")
  sourceLocation   Location? @relation("PickSourceLocation", fields: [sourceLocationId], references: [id])

  // Quantities
  requiredQty Int @map("required_qty")
  pickedQty   Int @default(0) @map("picked_qty")

  // Scan verification
  scannedBarcode String?   @map("scanned_barcode")
  verifiedAt     DateTime? @map("verified_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([pickListId])
  @@map("pick_list_items")
}

enum PickStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== CARRIER ACCOUNTS ====================

model CarrierAccount {
  id String @id @default(cuid())

  // Carrier provider
  provider CarrierProvider

  // Display name
  name String // e.g., "Shiprocket - Main Account"

  // API Credentials (encrypted)
  apiKey    String? @map("api_key")
  apiSecret String? @map("api_secret")
  apiToken  String? @map("api_token") // Cached auth token
  tokenExpiresAt DateTime? @map("token_expires_at")

  // Pickup location (carrier-side ID)
  pickupLocationId   String? @map("pickup_location_id")
  pickupLocationName String? @map("pickup_location_name")

  // Settings
  isDefault Boolean @default(false) @map("is_default")
  isActive  Boolean @default(true) @map("is_active")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  shipments Shipment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("carrier_accounts")
}

enum CarrierProvider {
  SHIPROCKET
  DELHIVERY
  OWN_FLEET
}

// ==================== SHIPMENTS & TRACKING ====================

model Shipment {
  id             String @id @default(cuid())
  shipmentNumber String @unique @map("shipment_number")

  // Order link
  orderId String     @map("order_id")
  order   SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Carrier details
  carrierAccountId String?         @map("carrier_account_id")
  carrierAccount   CarrierAccount? @relation(fields: [carrierAccountId], references: [id])
  carrierName      String?         @map("carrier_name") // e.g., "BlueDart", "Delhivery Express"
  carrierOrderId   String?         @map("carrier_order_id") // Carrier-side order ID
  courierCompanyId Int?            @map("courier_company_id") // Shiprocket courier company ID

  // AWB (Air Waybill / Tracking Number)
  awbNumber String? @unique @map("awb_number")

  // URLs
  labelUrl    String? @map("label_url")
  manifestUrl String? @map("manifest_url")
  trackingUrl String? @map("tracking_url")

  // Package details
  weightGrams Int? @map("weight_grams")
  lengthCm    Int? @map("length_cm")
  breadthCm   Int? @map("breadth_cm")
  heightCm    Int? @map("height_cm")

  // Status
  status       ShipmentStatus @default(CREATED)
  currentEvent String?        @map("current_event")

  // COD tracking
  codAmount       Decimal?    @map("cod_amount") @db.Decimal(12, 2)
  codCollected    Boolean     @default(false) @map("cod_collected")
  codRemittedAt   DateTime?   @map("cod_remitted_at")
  codRemittanceId String?     @map("cod_remittance_id")
  codRemittance   CODRemittance? @relation(fields: [codRemittanceId], references: [id])

  // NDR (Non-Delivery Report)
  ndrStatus      NDRStatus? @map("ndr_status")
  ndrReason      String?    @map("ndr_reason")
  ndrActionTaken String?    @map("ndr_action_taken")
  ndrAttempts    Int        @default(0) @map("ndr_attempts")

  // E-Way Bill
  ewayBillNumber String? @map("eway_bill_number")

  // Proof of delivery
  podPhoto    String? @map("pod_photo")
  podSignature String? @map("pod_signature")
  deliveredAt DateTime? @map("delivered_at")

  // Dates
  pickedUpAt    DateTime? @map("picked_up_at")
  inTransitAt   DateTime? @map("in_transit_at")
  outForDeliveryAt DateTime? @map("out_for_delivery_at")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  trackingEvents ShipmentTracking[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([orderId])
  @@index([awbNumber])
  @@index([status])
  @@index([ndrStatus])
  @@map("shipments")
}

model ShipmentTracking {
  id String @id @default(cuid())

  shipmentId String   @map("shipment_id")
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  // Event details
  status      String
  statusCode  String?  @map("status_code")
  description String?
  location    String?
  city        String?

  // Raw carrier payload for debugging
  rawPayload Json? @map("raw_payload") @db.JsonB

  eventAt DateTime @map("event_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([shipmentId])
  @@index([eventAt])
  @@map("shipment_tracking")
}

enum ShipmentStatus {
  CREATED
  PICKUP_SCHEDULED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RTO_INITIATED
  RTO_DELIVERED
  CANCELLED
  LOST
}

enum NDRStatus {
  ACTION_REQUIRED
  REATTEMPT_REQUESTED
  RTO_REQUESTED
  RESOLVED
}

// ==================== COD REMITTANCE ====================

model CODRemittance {
  id              String @id @default(cuid())
  remittanceNumber String @unique @map("remittance_number")

  // Batch details
  totalAmount   Decimal @map("total_amount") @db.Decimal(12, 2)
  shipmentsCount Int    @map("shipments_count")

  // Payment details
  status          CODRemittanceStatus @default(PENDING)
  paidAt          DateTime?           @map("paid_at")
  bankReference   String?             @map("bank_reference")
  paymentMode     String?             @map("payment_mode") // NEFT, IMPS, etc.

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  shipments Shipment[]
  items     CODRemittanceItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@map("cod_remittances")
}

model CODRemittanceItem {
  id String @id @default(cuid())

  remittanceId String        @map("remittance_id")
  remittance   CODRemittance @relation(fields: [remittanceId], references: [id], onDelete: Cascade)

  // Shipment reference
  shipmentId String  @map("shipment_id")
  awbNumber  String  @map("awb_number")
  orderNumber String @map("order_number")

  // Amount
  codAmount Decimal @map("cod_amount") @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([remittanceId])
  @@map("cod_remittance_items")
}

enum CODRemittanceStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

// ==================== PURCHASE ORDERS ====================

model PurchaseOrder {
  id       String @id @default(cuid())
  poNumber String @unique @map("po_number")

  // Supplier
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Delivery location
  deliveryLocationId String?   @map("delivery_location_id")
  deliveryLocation   Location? @relation("PODeliveryLocation", fields: [deliveryLocationId], references: [id])

  // Amounts
  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  shipping  Decimal @default(0) @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)
  currency  String  @default("INR")

  // Payment terms
  paymentTerms String? @map("payment_terms") // Net 30, Net 60, etc.
  dueDate      DateTime? @map("due_date")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  paidAmount    Decimal       @default(0) @map("paid_amount") @db.Decimal(12, 2)

  // Status
  status PurchaseOrderStatus @default(DRAFT)

  // E-Way Bill
  ewayBillNumber  String?   @map("eway_bill_number")
  ewayBillDate    DateTime? @map("eway_bill_date")
  transporterName String?   @map("transporter_name")
  vehicleNumber   String?   @map("vehicle_number")

  // Approval
  approvedById String?   @map("approved_by_id")
  approvedAt   DateTime? @map("approved_at")

  // Notes
  notes         String?
  internalNotes String? @map("internal_notes")

  // Audit
  createdById String @map("created_by_id")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  items         PurchaseOrderItem[]
  goodsReceipts GoodsReceipt[]
  payments      SupplierPayment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([supplierId])
  @@index([status])
  @@index([paymentStatus])
  @@index([dueDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id String @id @default(cuid())

  poId String        @map("po_id")
  po   PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id])

  // Product snapshot
  productName String  @map("product_name")
  sku         String?
  hsnCode     String? @map("hsn_code")

  // Quantities
  orderedQty  Int @map("ordered_qty")
  receivedQty Int @default(0) @map("received_qty")
  rejectedQty Int @default(0) @map("rejected_qty")

  // Pricing
  unitCost Decimal @map("unit_cost") @db.Decimal(12, 2)
  taxRate  Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)
  total    Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([poId])
  @@map("purchase_order_items")
}

model SupplierPayment {
  id            String @id @default(cuid())
  paymentNumber String @unique @map("payment_number")

  // Purchase Order
  poId String        @map("po_id")
  po   PurchaseOrder @relation(fields: [poId], references: [id])

  // Supplier
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Payment details
  amount          Decimal     @db.Decimal(12, 2)
  paymentMode     PaymentMode @map("payment_mode")
  paymentDate     DateTime    @map("payment_date")
  referenceNumber String?     @map("reference_number") // UTR / cheque number
  notes           String?

  // Audit
  recordedById String @map("recorded_by_id")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([poId])
  @@index([supplierId])
  @@index([paymentDate])
  @@map("supplier_payments")
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  CLOSED
}

// ==================== GOODS RECEIPTS (GRN) ====================

model GoodsReceipt {
  id        String @id @default(cuid())
  grnNumber String @unique @map("grn_number")

  // Purchase Order link (optional for ad-hoc receipts)
  poId String?         @map("po_id")
  po   PurchaseOrder?  @relation(fields: [poId], references: [id])

  // Supplier
  supplierId String   @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Receiving location
  receivingLocationId String?   @map("receiving_location_id")
  receivingLocation   Location? @relation("GRNReceivingLocation", fields: [receivingLocationId], references: [id])

  // Status
  status GRNStatus @default(PENDING)

  // Supplier invoice reference
  supplierInvoiceNumber String? @map("supplier_invoice_number")
  supplierInvoiceDate   DateTime? @map("supplier_invoice_date")

  // QC
  qcStatus String? @map("qc_status") // PASSED, FAILED, PARTIAL

  // Notes
  notes String?

  // Audit
  receivedById String @map("received_by_id")
  completedAt  DateTime? @map("completed_at")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  items GoodsReceiptItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([poId])
  @@index([supplierId])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id String @id @default(cuid())

  grnId String       @map("grn_id")
  grn   GoodsReceipt @relation(fields: [grnId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id])

  // Product snapshot
  productName String @map("product_name")

  // Quantities
  expectedQty Int @map("expected_qty")
  receivedQty Int @default(0) @map("received_qty")
  rejectedQty Int @default(0) @map("rejected_qty")

  // Rejection reason
  rejectionReason String? @map("rejection_reason")

  // Lot/Batch creation
  lotNumber   String? @map("lot_number")
  batchNumber String? @map("batch_number")
  expiryDate  DateTime? @map("expiry_date")

  // Putaway location
  putawayLocationId String? @map("putaway_location_id")

  // Unit cost
  unitCost Decimal @map("unit_cost") @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([grnId])
  @@map("goods_receipt_items")
}

enum GRNStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== RETURNS (Phase 3) ====================

model ReturnRequest {
  id           String @id @default(cuid())
  returnNumber String @unique @map("return_number")

  // Order link
  orderId String     @map("order_id")
  order   SalesOrder @relation(fields: [orderId], references: [id])

  // Customer
  customerId String?   @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])

  // Type and reason
  type   ReturnType
  reason String // Customer-facing reason
  notes  String? // Internal notes

  // Status
  status ReturnStatus @default(REQUESTED)

  // Inspection
  inspectedAt  DateTime? @map("inspected_at")
  inspectedBy  String?   @map("inspected_by")
  inspectionNotes String? @map("inspection_notes")

  // Refund
  refundAmount  Decimal?  @map("refund_amount") @db.Decimal(12, 2)
  refundMode    String?   @map("refund_mode") // ORIGINAL_PAYMENT, STORE_CREDIT, BANK_TRANSFER
  refundedAt    DateTime? @map("refunded_at")

  // Restock
  restockApproved Boolean @default(false) @map("restock_approved")

  // Shipment for return pickup
  returnShipmentId String?   @map("return_shipment_id")
  returnAwb        String?   @map("return_awb")

  // Audit
  createdById String @map("created_by_id")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  items ReturnRequestItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([orderId])
  @@index([status])
  @@map("return_requests")
}

model ReturnRequestItem {
  id String @id @default(cuid())

  returnId String        @map("return_id")
  return   ReturnRequest @relation(fields: [returnId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id])

  // Product snapshot
  productName String @map("product_name")

  // Quantities
  quantity Int

  // Condition grade after inspection
  conditionGrade String? @map("condition_grade") // A=Resell, B=Refurbish, C=Scrap

  // Restock info
  restocked   Boolean @default(false)
  restockedAt DateTime? @map("restocked_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([returnId])
  @@map("return_request_items")
}

enum ReturnType {
  CUSTOMER_RETURN
  RTO // Return to Origin (carrier)
  EXCHANGE
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  PICKUP_SCHEDULED
  IN_TRANSIT
  RECEIVED
  INSPECTING
  INSPECTED
  REFUND_INITIATED
  REFUNDED
  CLOSED
  REJECTED
}

// ==================== WAVE PLANNING (Phase 3) ====================

model Wave {
  id         String @id @default(cuid())
  waveNumber String @unique @map("wave_number")

  // Status
  status WaveStatus @default(DRAFT)

  // Planning
  name        String? // Optional wave name (e.g., "Morning Batch - Zone A")
  carrierZone String? @map("carrier_zone")

  // Timing
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Audit
  createdById String @map("created_by_id")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  orders WaveOrder[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@map("waves")
}

model WaveOrder {
  id String @id @default(cuid())

  waveId String @map("wave_id")
  wave   Wave   @relation(fields: [waveId], references: [id], onDelete: Cascade)

  orderId String     @map("order_id")
  order   SalesOrder @relation(fields: [orderId], references: [id])

  // Sequence in wave for pick route optimization
  sequence Int @default(0)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([waveId, orderId])
  @@index([waveId])
  @@map("wave_orders")
}

enum WaveStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== CYCLE COUNTING (Phase 4) ====================

model CycleCount {
  id       String @id @default(cuid())
  ccNumber String @unique @map("cc_number")

  // Location being counted
  locationId String   @map("location_id")
  location   Location @relation("CycleCountLocation", fields: [locationId], references: [id])

  // Count configuration
  type       CycleCountType   @default(FULL)
  status     CycleCountStatus @default(DRAFT)
  blindCount Boolean          @default(false) @map("blind_count")
  abcFilter  String?          @map("abc_filter") // A, B, C, or null for all

  // Scheduling
  scheduledDate DateTime? @map("scheduled_date")

  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  verifiedAt  DateTime? @map("verified_at")

  // Assignment
  assignedToId String? @map("assigned_to_id")
  assignedTo   User?   @relation("CycleCountAssignee", fields: [assignedToId], references: [id])

  verifiedById String? @map("verified_by_id")
  verifiedBy   User?   @relation("CycleCountVerifier", fields: [verifiedById], references: [id])

  createdById String @map("created_by_id")
  createdBy   User   @relation("CycleCountCreator", fields: [createdById], references: [id])

  // Summary stats (updated on complete)
  totalItems    Int @default(0) @map("total_items")
  countedItems  Int @default(0) @map("counted_items")
  varianceCount Int @default(0) @map("variance_count")
  varianceValue Decimal @default(0) @map("variance_value") @db.Decimal(14, 2)

  notes String?

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  items CycleCountItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@index([locationId])
  @@map("cycle_counts")
}

model CycleCountItem {
  id String @id @default(cuid())

  cycleCountId String     @map("cycle_count_id")
  cycleCount   CycleCount @relation(fields: [cycleCountId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  // Snapshot of expected quantity at count start
  expectedQuantity Int @map("expected_quantity")

  // Counted quantity (null = not yet counted)
  countedQuantity Int? @map("counted_quantity")

  // Variance (calculated on complete)
  variance        Int?     @default(0)
  variancePercent Decimal? @map("variance_percent") @db.Decimal(8, 2)
  varianceValue   Decimal? @map("variance_value") @db.Decimal(14, 2)

  // Status
  status CycleCountItemStatus @default(PENDING)

  notes     String?
  countedAt DateTime? @map("counted_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([cycleCountId])
  @@index([productId])
  @@map("cycle_count_items")
}

enum CycleCountType {
  FULL
  ABC_BASED
  RANDOM_SAMPLE
  SPOT_CHECK
}

enum CycleCountStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  VERIFIED
  CANCELLED
}

enum CycleCountItemStatus {
  PENDING
  COUNTED
  VERIFIED
  ADJUSTED
}

// ==================== INVENTORY INTELLIGENCE (Phase 5) ====================

model DemandSnapshot {
  id        String @id @default(cuid())

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Period
  periodType  DemandPeriodType @map("period_type")
  periodStart DateTime         @map("period_start")
  periodEnd   DateTime         @map("period_end")

  // Aggregated metrics
  totalQuantity Int     @default(0) @map("total_quantity")
  totalRevenue  Decimal @default(0) @map("total_revenue") @db.Decimal(14, 2)
  totalCost     Decimal @default(0) @map("total_cost") @db.Decimal(14, 2)
  orderCount    Int     @default(0) @map("order_count")

  // Moving averages & stats
  movingAvg7d  Decimal? @map("moving_avg_7d") @db.Decimal(10, 4)
  movingAvg30d Decimal? @map("moving_avg_30d") @db.Decimal(10, 4)
  stdDeviation Decimal? @map("std_deviation") @db.Decimal(10, 4)

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, periodType, periodStart])
  @@index([tenantId])
  @@index([productId, periodType])
  @@index([periodStart])
  @@map("demand_snapshots")
}

enum DemandPeriodType {
  DAILY
  WEEKLY
  MONTHLY
}

model ReorderSuggestion {
  id        String @id @default(cuid())

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Suggestion details
  suggestedQty   Int @map("suggested_qty")
  currentStock   Int @map("current_stock")
  reorderPoint   Int @map("reorder_point")
  safetyStock    Int @map("safety_stock")
  avgDailyDemand Decimal @map("avg_daily_demand") @db.Decimal(10, 4)
  leadTimeDays   Int     @map("lead_time_days")
  estimatedCost  Decimal @map("estimated_cost") @db.Decimal(14, 2)

  // Preferred supplier
  supplierId String?   @map("supplier_id")
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  // Status
  status  ReorderSuggestionStatus @default(PENDING)
  urgency ReorderUrgency          @default(NORMAL)

  // Calculations
  daysUntilStockout Int? @map("days_until_stockout")

  // Conversion
  convertedPoId String? @map("converted_po_id")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@index([urgency])
  @@index([productId])
  @@map("reorder_suggestions")
}

enum ReorderSuggestionStatus {
  PENDING
  ACCEPTED
  DISMISSED
  CONVERTED_TO_PO
}

enum ReorderUrgency {
  CRITICAL
  HIGH
  NORMAL
  LOW
}

model InventoryKpiSnapshot {
  id String @id @default(cuid())

  // Period
  periodDate DateTime         @map("period_date")
  periodType DemandPeriodType @map("period_type")

  // KPI metrics
  inventoryTurnover  Decimal? @map("inventory_turnover") @db.Decimal(10, 4)
  gmroi              Decimal? @db.Decimal(10, 4)
  avgDaysOfSupply    Decimal? @map("avg_days_of_supply") @db.Decimal(10, 2)
  fillRate           Decimal? @map("fill_rate") @db.Decimal(5, 4) // 0.0000 to 1.0000
  stockoutRate       Decimal? @map("stockout_rate") @db.Decimal(5, 4)
  totalInventoryValue Decimal? @map("total_inventory_value") @db.Decimal(16, 2)
  deadStockValue     Decimal? @map("dead_stock_value") @db.Decimal(14, 2)
  deadStockCount     Int?     @map("dead_stock_count")

  // Inventory Valuation & Working Capital (P6-T4)
  totalInventoryValueAtSale Decimal? @map("total_inventory_value_at_sale") @db.Decimal(16, 2)
  carryingCostMonthly       Decimal? @map("carrying_cost_monthly") @db.Decimal(14, 2)
  carryingCostRate          Decimal? @map("carrying_cost_rate") @db.Decimal(5, 4)
  inventoryToRevenueRatio   Decimal? @map("inventory_to_revenue_ratio") @db.Decimal(10, 4)
  inventoryDays             Decimal? @map("inventory_days") @db.Decimal(10, 2)

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([tenantId, periodDate, periodType])
  @@index([tenantId])
  @@index([periodDate])
  @@map("inventory_kpi_snapshots")
}

// ==================== SUPPLY CHAIN OPTIMIZATION (Phase 6) ====================

enum SupplierPriority {
  PREFERRED
  BACKUP
  EMERGENCY
}

model ProductSupplier {
  id String @id @default(cuid())

  productId  String  @map("product_id")
  product    Product @relation("ProductSuppliers", fields: [productId], references: [id], onDelete: Cascade)

  supplierId String   @map("supplier_id")
  supplier   Supplier @relation("SupplierProducts", fields: [supplierId], references: [id], onDelete: Cascade)

  // Supplier-specific product info
  supplierSku         String? @map("supplier_sku")
  supplierProductName String? @map("supplier_product_name")

  // Pricing & terms
  unitCost     Decimal @map("unit_cost") @db.Decimal(12, 2)
  moq          Int     @default(1) // Minimum order quantity
  leadTimeDays Int     @map("lead_time_days")

  // Priority & status
  priority SupplierPriority @default(BACKUP)
  isActive Boolean          @default(true) @map("is_active")

  // Notes
  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, supplierId])
  @@index([productId])
  @@index([supplierId])
  @@map("product_suppliers")
}

// ==================== BOM / KIT MANAGEMENT (Phase 6) ====================

enum BOMStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum AssemblyType {
  ASSEMBLY
  DISASSEMBLY
}

enum AssemblyOrderStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model BillOfMaterial {
  id        String @id @default(cuid())
  bomNumber String @unique @map("bom_number")

  // Finished product this BOM produces
  productId String  @map("product_id")
  product   Product @relation("ProductBOMs", fields: [productId], references: [id], onDelete: Cascade)

  version     Int       @default(1)
  name        String?
  description String?
  status      BOMStatus @default(DRAFT)
  isActive    Boolean   @default(true) @map("is_active")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  items          BOMItem[]
  assemblyOrders AssemblyOrder[]

  @@unique([productId, version])
  @@index([tenantId])
  @@index([productId])
  @@map("bills_of_material")
}

model BOMItem {
  id    String @id @default(cuid())
  bomId String @map("bom_id")
  bom   BillOfMaterial @relation(fields: [bomId], references: [id], onDelete: Cascade)

  // Component product consumed
  componentProductId String  @map("component_product_id")
  componentProduct   Product @relation("ComponentBOMItems", fields: [componentProductId], references: [id], onDelete: Cascade)

  // How many units of this component per 1 finished good
  quantity       Decimal @db.Decimal(12, 4)
  wastagePercent Decimal @default(0) @map("wastage_percent") @db.Decimal(5, 2)
  notes          String?

  @@unique([bomId, componentProductId])
  @@index([bomId])
  @@index([componentProductId])
  @@map("bom_items")
}

model AssemblyOrder {
  id             String @id @default(cuid())
  assemblyNumber String @unique @map("assembly_number")

  bomId String         @map("bom_id")
  bom   BillOfMaterial @relation(fields: [bomId], references: [id])

  type     AssemblyType        @default(ASSEMBLY)
  quantity Int
  status   AssemblyOrderStatus @default(DRAFT)

  // Optional location for stock operations
  locationId String?   @map("location_id")
  location   Location? @relation("AssemblyLocation", fields: [locationId], references: [id])

  notes       String?
  completedAt DateTime? @map("completed_at")
  createdById String    @map("created_by_id")

  // Multi-tenant
  tenantId String @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([bomId])
  @@index([status])
  @@map("assembly_orders")
}

// ============================================================
// Dynamic Pricing Rules (Phase 7)
// ============================================================

model PricingRule {
  id     String @id @default(cuid())
  number String @unique // PR-YYYY-XXXX

  name        String
  description String?

  // What inventory condition triggers this rule
  triggerType        PricingTrigger @map("trigger_type")
  thresholdValue     Float          @map("threshold_value")     // e.g. 100 units, 60 days, 0.5 units/day
  thresholdOperator  String         @default("gt") @map("threshold_operator") // gt, lt, gte, lte

  // Scope — which products the rule applies to
  scope   PricingRuleScope @default(ALL)
  scopeId String?          @map("scope_id") // productId, categoryId, or ABC class letter

  // Price adjustment
  adjustmentType  DiscountType @default(PERCENTAGE) @map("adjustment_type")
  adjustmentValue Decimal      @map("adjustment_value") @db.Decimal(12, 2) // e.g. 10.00 = 10%

  // Progressive markdown (optional)
  isProgressive    Boolean @default(false) @map("is_progressive")
  progressiveSteps Json?   @map("progressive_steps") // [{afterDays: 7, value: 10}, {afterDays: 14, value: 20}]

  // Time bounds
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")

  // Priority & status
  priority Int              @default(0)
  isActive Boolean          @default(true) @map("is_active")
  status   PricingRuleStatus @default(DRAFT)

  // Audit
  createdById String @map("created_by_id")
  tenantId    String @map("tenant_id")
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([isActive, startDate, endDate])
  @@map("pricing_rules")
}

enum PricingTrigger {
  STOCK_LEVEL     // If stock > or < threshold units
  DAYS_OF_SUPPLY  // If days-of-supply > threshold days
  INVENTORY_AGE   // If avg inventory age > threshold days
  SLOW_MOVER      // If daily velocity < threshold units/day
  SCHEDULED       // Time-based (flash sale, seasonal)
}

enum PricingRuleScope {
  ALL       // All active products
  PRODUCT   // Specific product (scopeId = productId)
  CATEGORY  // Products in category (scopeId = categoryId)
  ABC_CLASS // Products with ABC class (scopeId = A, B, or C)
}

enum PricingRuleStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
}
